<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="eu.europa.ec.cc.processcentre.repository.ProcessMapper">

  <select id="findById">
    SELECT PROCESS_INSTANCE_ID FROM T_PROCESS WHERE PROCESS_INSTANCE_ID = #{value}
  </select>

  <select id="search" resultType="eu.europa.ec.cc.processcentre.repository.model.SearchProcessQueryResponse">
    SELECT PROCESS_INSTANCE_ID FROM T_PROCESS
    WHERE PROCESS_INSTANCE_ID = #{value}
  </select>

  <insert id="ensureProcessExists" parameterType="string">
    INSERT INTO T_PROCESS (PROCESS_INSTANCE_ID)
    VALUES (#{value})
    ON CONFLICT (PROCESS_INSTANCE_ID) DO NOTHING;
  </insert>

  <insert id="insertOrUpdateProcess">
    INSERT INTO T_PROCESS (
      PROCESS_INSTANCE_ID,
      DOMAIN_KEY,
      PROVIDER_ID,
      PROCESS_TYPE_KEY,
      STARTED_ON,
      BUSINESS_STATUS,
      RESPONSIBLE_ORGANISATION_ID,
      STARTED_BY,
      STARTED_ON_BEHALF_OF,
      ASSOCIATED_PORTFOLIO_ITEM_IDS
    )  VALUES (
    #{processInstanceId},
    #{domainKey},
    #{providerId},
    #{processTypeKey},
    #{startedOn},
    #{businessStatus},
    #{responsibleOrganisationId},
    #{startedBy},
    #{startedOnBehalfOf},
    #{associatedPortfolioItemIds}
    )
    ON CONFLICT (PROCESS_INSTANCE_ID) DO UPDATE SET
    DOMAIN_KEY = EXCLUDED.DOMAIN_KEY,
    PROVIDER_ID = EXCLUDED.PROVIDER_ID,
    PROCESS_TYPE_KEY = EXCLUDED.PROCESS_TYPE_KEY,
    STARTED_ON = EXCLUDED.STARTED_ON,
    BUSINESS_STATUS = EXCLUDED.BUSINESS_STATUS,
    RESPONSIBLE_ORGANISATION_ID = EXCLUDED.RESPONSIBLE_ORGANISATION_ID,
    STARTED_BY = EXCLUDED.STARTED_BY,
    STARTED_ON_BEHALF_OF = EXCLUDED.STARTED_ON_BEHALF_OF,
    ASSOCIATED_PORTFOLIO_ITEM_IDS = EXCLUDED.ASSOCIATED_PORTFOLIO_ITEM_IDS
  </insert>

  <update id="updateProcessSecurity">
    UPDATE T_PROCESS SET SECURITY_APPLICATION_ID = #{applicationId}, SECURITY_SECUNDA_TASK = #{secundaTask},
    SECURITY_SCOPE_TYPE_ID = #{scopeTypeId},
    SECURITY_SCOPE_ID = #{scopeId},
    SECURITY_SCOPE_ID_VALUE = #{scopeIdVal},
    TITLE_TEMPLATE = #{titleTemplate}
  </update>

</mapper>